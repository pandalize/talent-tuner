name: ğŸš€ Auto Deploy to pandalize.com

on:
  push:
    branches: [ main ]    # main ã« push ã•ã‚ŒãŸã¨ãã ã‘å®Ÿè¡Œ
  workflow_dispatch:      # æ‰‹å‹•å®Ÿè¡Œã‚’æ®‹ã™

jobs:
  deploy:
    name: Deploy to pandalize.com
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: ğŸ“¥ Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ” Run translation validation # frontend/scripts/validate-translations.js ãŒãƒªãƒã‚¸ãƒˆãƒªã«å­˜åœ¨ã—ãªã„ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å¯èƒ½æ€§ã‚ã‚Š
        working-directory: ./frontend
        run: npm run validate:translations

      - name: ğŸ“¦ Build project
        working-directory: ./frontend
        run: npm run build

      - name: ğŸ” Check FTP credentials
        run: |
          if [ -z "${{ secrets.FTP_HOST }}" ]; then
            echo "âŒ FTP_HOST secret is not set"
            exit 1
          fi
          echo "âœ… FTP credentials are configured"

      - name: ğŸš€ Deploy to FTP (Custom Script)
        working-directory: ./frontend
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: node deploy-ftp.js

      - name: ğŸ“§ Send success notification
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âœ… pandalize.com ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          body: "ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ"

      - name: ğŸ“§ Send failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âŒ pandalize.com ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          body: "ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"