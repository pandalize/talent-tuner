name: ğŸš€ Auto Deploy to pandalize.com

on:
  push:
    branches: [ main ]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  deploy:
    name: Deploy to pandalize.com
    runs-on: ubuntu-latest    # ...existing code...
    name: Deploy Serverside to Vercel
    
    on:
      push:
        branches:
          - prod
        paths:
          - 'serverside/**'
      workflow_dispatch:  # â† æ‰‹å‹•å®Ÿè¡Œã‚’æœ‰åŠ¹åŒ–
    
    jobs:
      deploy:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
    
          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: '20'
    
          - name: Validate Vercel secrets
            run: |
              if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
                echo "âŒ VERCEL_TOKEN is not set. Add it to repository Secrets."
                exit 1
              fi
              if [ -z "${{ secrets.VERCEL_ORG_ID }}" ] || [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
                echo "âš ï¸ VERCEL_ORG_ID or VERCEL_PROJECT_ID not set â€” deployment may still work but verify your config."
              fi
    
          - name: Install serverside deps
            working-directory: ./serverside
            run: npm ci
    
          - name: Build serverside (local check)
            working-directory: ./serverside
            run: npm run build
    
          - name: Verify Vercel token (debug)
            env:
              VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
            run: |
              # whoami ã§ token ãŒæœ‰åŠ¹ã‹ç¢ºèªï¼ˆå¤±æ•—ãªã‚‰ã“ã“ã§æ­¢ã‚ã‚‹ï¼‰
              npx vercel whoami --token "$VERCEL_TOKEN" || (echo "VERCEL_TOKEN invalid" && exit 1)
    
          - name: Deploy to Vercel (pull / build / deploy)
            env:
              VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
              VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
              VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
            working-directory: ./serverside
            run: |
              # pull project env (optional), build, and deploy
              npx vercel pull --yes --environment=production --token="$VERCEL_TOKEN"
              npx vercel build --prod --token="$VERCEL_TOKEN"
              npx vercel deploy --prebuilt --prod --token="$VERCEL_TOKEN"
    # ...existing code...
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
          
      - name: ğŸ“¥ Install dependencies
        working-directory: ./frontend
        run: npm ci
          
      - name: ğŸ” Run translation validation
        working-directory: ./frontend
        run: npm run validate:translations
          
      - name: ğŸ“¦ Build project
        working-directory: ./frontend
        run: npm run build
          
      - name: ğŸ” Check FTP credentials
        run: |
          if [ -z "${{ secrets.FTP_HOST }}" ]; then
            echo "âŒ FTP_HOST secret is not set"
            echo "Please configure GitHub Secrets:"
            echo "  FTP_HOST, FTP_USER, FTP_PASSWORD"
            echo "See DEPLOYMENT_SETUP.md for details"
            exit 1
          fi
          echo "âœ… FTP credentials are configured"
          
      - name: ğŸš€ Deploy to FTP (Custom Script)
        working-directory: ./frontend
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: node deploy-ftp.js
          
      - name: ğŸ“§ Send success notification
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âœ… pandalize.com ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ"
          to: ${{ secrets.NOTIFICATION_EMAIL }},${{ secrets.NOTIFICATION_EMAIL_2 }},${{ secrets.NOTIFICATION_EMAIL_3 }},${{ secrets.NOTIFICATION_EMAIL_4 }}
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          body: |
            ğŸ‰ pandalize.com ã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¾ã—ãŸï¼
            
            ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤è©³ç´°:
            â€¢ ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            â€¢ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}
            â€¢ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
            â€¢ å®Ÿè¡Œè€…: ${{ github.actor }}
            â€¢ å®Ÿè¡Œæ™‚åˆ»: ${{ github.event.head_commit.timestamp }}
            
            ğŸ”— ã‚µã‚¤ãƒˆ URL: https://pandalize.com/
            ğŸ“ GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            æœ€æ–°ã®å¤‰æ›´å†…å®¹:
            ${{ github.event.head_commit.message }}
            
            --
            GitHub Actions è‡ªå‹•é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
            
      - name: ğŸ“§ Send failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âŒ pandalize.com ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
          to: ${{ secrets.NOTIFICATION_EMAIL }},${{ secrets.NOTIFICATION_EMAIL_2 }},${{ secrets.NOTIFICATION_EMAIL_3 }},${{ secrets.NOTIFICATION_EMAIL_4 }}
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          body: |
            âš ï¸ pandalize.com ã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚
            
            ğŸ“Š å¤±æ•—è©³ç´°:
            â€¢ ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            â€¢ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}
            â€¢ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
            â€¢ å®Ÿè¡Œè€…: ${{ github.actor }}
            â€¢ å®Ÿè¡Œæ™‚åˆ»: ${{ github.event.head_commit.timestamp }}
            
            ğŸ“ ãƒ­ã‚°ã‚’ç¢ºèª: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            å¯¾è±¡ã®ã‚³ãƒŸãƒƒãƒˆ:
            ${{ github.event.head_commit.message }}
            
            --
            GitHub Actions è‡ªå‹•é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 