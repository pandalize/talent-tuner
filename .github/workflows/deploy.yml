name: ğŸš€ Auto Deploy to pandalize.com

on:
  push:
    branches: [ main ]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  deploy:
    name: Deploy to pandalize.com
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'my-vue-app/package-lock.json'
          
      - name: ğŸ“¥ Install dependencies
        working-directory: ./my-vue-app
        run: npm ci
          
      - name: ğŸ” Run translation validation
        working-directory: ./my-vue-app
        run: npm run validate:translations
          
      - name: ğŸ“¦ Build project
        working-directory: ./my-vue-app
        run: npm run build
          
      - name: ğŸ” Check FTP credentials
        run: |
          if [ -z "${{ secrets.FTP_HOST }}" ]; then
            echo "âŒ FTP_HOST secret is not set"
            echo "Please configure GitHub Secrets:"
            echo "  FTP_HOST, FTP_USER, FTP_PASSWORD"
            echo "See DEPLOYMENT_SETUP.md for details"
            exit 1
          fi
          echo "âœ… FTP credentials are configured"
          
      - name: ğŸš€ Deploy to FTP (Custom Script)
        working-directory: ./my-vue-app
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: node deploy-ftp.js
          
      - name: ğŸ“§ Send success notification
        if: ${{ success() && secrets.NOTIFICATION_EMAIL != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âœ… pandalize.com ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          body: |
            ğŸ‰ pandalize.com ã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¾ã—ãŸï¼
            
            ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤è©³ç´°:
            â€¢ ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            â€¢ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}
            â€¢ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
            â€¢ å®Ÿè¡Œè€…: ${{ github.actor }}
            â€¢ å®Ÿè¡Œæ™‚åˆ»: ${{ github.event.head_commit.timestamp }}
            
            ğŸ”— ã‚µã‚¤ãƒˆ URL: https://pandalize.com/
            ğŸ“ GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            æœ€æ–°ã®å¤‰æ›´å†…å®¹:
            ${{ github.event.head_commit.message }}
            
            --
            GitHub Actions è‡ªå‹•é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
            
      - name: ğŸ“§ Send failure notification
        if: ${{ failure() && secrets.NOTIFICATION_EMAIL != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âŒ pandalize.com ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          body: |
            âš ï¸ pandalize.com ã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚
            
            ğŸ“Š å¤±æ•—è©³ç´°:
            â€¢ ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            â€¢ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}
            â€¢ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
            â€¢ å®Ÿè¡Œè€…: ${{ github.actor }}
            â€¢ å®Ÿè¡Œæ™‚åˆ»: ${{ github.event.head_commit.timestamp }}
            
            ğŸ“ ãƒ­ã‚°ã‚’ç¢ºèª: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            å¯¾è±¡ã®ã‚³ãƒŸãƒƒãƒˆ:
            ${{ github.event.head_commit.message }}
            
            --
            GitHub Actions è‡ªå‹•é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
            
      - name: ğŸ’¬ Success message (No email configured)
        if: ${{ success() && secrets.NOTIFICATION_EMAIL == '' }}
        run: |
          echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¾ã—ãŸï¼"
          echo "ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ã€GitHub Secretsã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š"
          echo "   NOTIFICATION_EMAIL, MAIL_USERNAME, MAIL_PASSWORD"
          
      - name: ğŸ’¬ Failure message (No email configured)  
        if: ${{ failure() && secrets.NOTIFICATION_EMAIL == '' }}
        run: |
          echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚"
          echo "ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ã€GitHub Secretsã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š"
          echo "   NOTIFICATION_EMAIL, MAIL_USERNAME, MAIL_PASSWORD"